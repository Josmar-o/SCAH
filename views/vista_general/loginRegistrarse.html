<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login / Registro - SCAH</title>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@700&family=Questrial&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Questrial', sans-serif;
      background: #f1f5f9;
      color: #333;
    }
    .spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px auto;
      width: 100%;
      text-align: center;
    }
    .input-error {
      border: 2px solid #d32f2f !important;
    }
    
    .container { display: flex; height: 100vh; }
    .left-panel {
      flex: 1;
      background-color: #004f98;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 3rem;
    }
    .left-panel h1 {
      font-family: 'Libre Baskerville', serif;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .left-panel p {
      font-size: 1.1rem;
      text-align: center;
      line-height: 1.6;
      max-width: 400px;
    }
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      background: white;
    }
    .form-box {
      width: 100%;
      max-width: 400px;
      background: #f9fafb;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid #c8c7c9;
      transition: box-shadow 0.3s ease;

      display: flex;
      flex-direction: column;

      /* üîí Lo importante para evitar desbordes */
      overflow-x: hidden;
      overflow-y: auto;
      max-height: 90vh;
    }
    
    .form-box h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #004f98;
      font-family: 'Libre Baskerville', serif;
    }
    .form-box label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    .form-box input, .form-box textarea {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #c8c7c9;
      border-radius: 6px;
      font-size: 1rem;
    }
    .form-box button {
      width: 100%;
      background-color: #2d93d5;
      color: white;
      padding: 0.8rem;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    textarea {
      width: 100%;
      max-width: 100%;
      resize: vertical;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    .form-box button:hover { background-color: #004f98; }
    .toggle-link {
      margin-top: 1rem;
      text-align: center;
      color: #2d93d5;
      cursor: pointer;
      font-size: 0.95rem;
    }
    
    .toggle-link:hover { text-decoration: underline; }
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .left-panel { display: none; }
      .form-box { max-width: 100%; padding: 1.5rem; overflow: visible; max-height: none;}
    }
    @media (max-width: 600px) {
      .form-box input,
      .form-box textarea {
        font-size: 0.95rem;
        padding: 0.65rem;
      }
      .form-box h2 { font-size: 1.4rem; }
      .form-box button {
        font-size: 1rem;
        padding: 0.7rem;
      }
    }
  </style>
  <script>
    function togglePassword(inputId, buttonId) {
      const input = document.getElementById(inputId);
      const button = document.getElementById(buttonId);
      if (input.type === 'password') {
        input.type = 'text';
        // √çcono ojo cerrado (ocultar)
        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
        </svg>`;
      } else {
        input.type = 'password';
        // √çcono ojo abierto (mostrar)
        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
        </svg>`;
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <h1>SCAH</h1>
      <p>Sistema de Citas y Atenci√≥n Hospitalaria. Accede a tus citas, consulta tu historial y mant√©n el control de tu salud.</p>
    </div>
    <div class="right-panel">
      <div class="form-box" id="formLogin">
        <h2>Iniciar Sesi√≥n</h2>
        <label for="email">Correo electr√≥nico</label>
        <input type="email" id="email" placeholder="ejemplo@correo.com" />
        <label for="password">Contrase√±a</label>
        <div style="position: relative;">
          <input type="password" id="password" placeholder="********" style="padding-right: 45px;" />
          <button type="button" onclick="togglePassword('password', 'togglePasswordBtn')" id="togglePasswordBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; padding: 5px; width: 24px; height: 24px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
            </svg>
          </button>
        </div>
        <button id="btnLogin">Ingresar</button>
        <div id="mensajeLogin" style="color: #d32f2f; margin-top: 10px; text-align: center;"></div>
        <div class="toggle-link" onclick="toggleForm()">¬øNo tienes cuenta? Reg√≠strate</div>
        <div class="toggle-link" onclick="mostrarRecuperar()">¬øOlvidaste tu contrase√±a?</div>
      </div>

      <div class="form-box" id="formRegister" style="display: none;">
        <h2>Registro de Paciente</h2>
        <label for="cedula">C√©dula/Pasaporte</label>
        <input type="text" id="cedula" required placeholder="Ej: 8-123-456, PE-123-456, E-123-456"/>
        <small style="color: #666; font-size: 0.85em; margin-top: -8px; margin-bottom: 12px; display: block;">
          üí° <strong>Debes ingresar los guiones manualmente.</strong><br>
          Formatos v√°lidos: 1-123-456 (hasta 13-xxxx-xxxxx), PE-xxxx-xxxxx, E-xxxx-xxxxxx, N-xxxx-xxxx, 1AV-xxxx-xxxxx (hasta 13AV), 1PI-xxxx-xxxxx (hasta 13PI)
        </small>
        <label for="primer_nombre">Primer Nombre</label>
        <input type="text" id="primer_nombre" required />
        <label for="segundo_nombre">Segundo Nombre</label>
        <input type="text" id="segundo_nombre" />
        <label for="primer_apellido">Primer Apellido</label>
        <input type="text" id="primer_apellido" required />
        <label for="segundo_apellido">Segundo Apellido</label>
        <input type="text" id="segundo_apellido" />
        <label for="fecha_nacimiento">Fecha de Nacimiento</label>
        <input type="date" id="fecha_nacimiento" required />
        <label for="telefono">Tel√©fono</label>
        <input type="tel" id="telefono" required placeholder="12345678"/>
        <label for="emailRegister">Correo electr√≥nico</label>
        <input type="email" id="emailRegister" required placeholder="usuario@correo.com"/>
        <label for="direccion">Direcci√≥n</label>
        <textarea id="direccion" rows="3"></textarea>
        <label for="passwordRegister">Contrase√±a</label>
        <div style="position: relative;">
          <input type="password" id="passwordRegister" required style="padding-right: 45px;" />
          <button type="button" onclick="togglePassword('passwordRegister', 'togglePasswordRegisterBtn')" id="togglePasswordRegisterBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; padding: 5px; width: 24px; height: 24px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
            </svg>
          </button>
        </div>
        <label for="confirmPasswordRegister">Confirmar Contrase√±a</label>
        <div style="position: relative;">
          <input type="password" id="confirmPasswordRegister" required style="padding-right: 45px;" />
          <button type="button" onclick="togglePassword('confirmPasswordRegister', 'toggleConfirmPasswordBtn')" id="toggleConfirmPasswordBtn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; padding: 5px; width: 24px; height: 24px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
              <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
            </svg>
          </button>
        </div>
        <small style="color: #666; font-size: 0.85em; margin-top: -8px; margin-bottom: 12px; display: block;">
          üîí <strong>Requisitos de contrase√±a:</strong><br>
          ‚Ä¢ Entre 8 y 16 caracteres<br>
          ‚Ä¢ Al menos 1 n√∫mero<br>
          ‚Ä¢ Al menos 1 s√≠mbolo (!@#$%^&*()_+-=[]{}|;:,.<>?)
        </small>
        <button id="btnRegistrarse">Registrarse</button>
        <div id="spinnerRegister" class="spinner" style="display:none;">
          <svg width="40" height="40" viewBox="0 0 40 40">
            <circle cx="20" cy="20" r="16" stroke="#2d93d5" stroke-width="4" fill="none" stroke-linecap="round">
              <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" from="0 20 20" to="360 20 20"/>
            </circle>
          </svg>
        </div>
        <div id="mensajeRegister" style="color: #d32f2f; margin-top: 10px; text-align: center;"></div>
        <div class="toggle-link" onclick="toggleForm()">¬øYa tienes cuenta? Inicia sesi√≥n</div>
      </div>

      <div class="form-box" id="formRecuperar" style="display: none;">
        <h2>Recuperar Contrase√±a</h2>
        <label for="emailRecuperar">Correo electr√≥nico</label>
        <input type="email" id="emailRecuperar" placeholder="usuario@correo.com" required />
        <button id="btnRecuperar">Enviar enlace</button>
        <div id="spinner" class="spinner" style="display:none;">
          <svg width="40" height="40" viewBox="0 0 40 40">
            <circle cx="20" cy="20" r="16" stroke="#2d93d5" stroke-width="4" fill="none" stroke-linecap="round">
              <animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" from="0 20 20" to="360 20 20"/>
            </circle>
          </svg>
        </div>
        <div id="mensajeRecuperar" style="color: #d32f2f; margin-top: 10px; text-align: center;"></div>
        <div class="toggle-link" onclick="mostrarLogin()">Volver a iniciar sesi√≥n</div>
      </div>
    </div>
  </div>

  <script>
    const telefonoInput = document.getElementById('telefono');
    //mascara de tel√©fono
    telefonoInput.addEventListener('input', function (e) {
      let value = this.value.replace(/\D/g, '');
      value = value.slice(0, 8);
      if (value.length > 4) {
        value = value.slice(0, 4) + '-' + value.slice(4);
      }
      this.value = value;
    });

    // Funci√≥n para validar c√©dula/pasaporte paname√±o
    function validarCedulaPanama(cedula) {
      if (!cedula || cedula.trim() === '') {
        return { valida: false, mensaje: 'C√©dula/pasaporte es requerido' };
      }

      const cedulaLimpia = cedula.trim().toUpperCase();
      
      // Verificar que tenga exactamente 2 guiones
      const guiones = (cedulaLimpia.match(/-/g) || []).length;
      if (guiones !== 2) {
        return { valida: false, mensaje: 'La c√©dula/pasaporte debe tener exactamente 2 guiones (-)' };
      }

      // Regular: 1-xxxx-xxxxx hasta 13-xxxx-xxxxx
      const regexRegular = /^([1-9]|1[0-3])-(\d{1,4})-(\d{1,5})$/;
      
      // Paname√±o nacido en el extranjero: PE-xxxx-xxxxx
      const regexPE = /^PE-(\d{1,4})-(\d{1,5})$/;
      
      // Extranjero con c√©dula: E-xxxx-xxxxxx
      const regexExtranjero = /^E-(\d{1,4})-(\d{1,6})$/;
      
      // Naturalizado: N-xxxx-xxxx
      const regexNaturalizado = /^N-(\d{1,4})-(\d{1,4})$/;
      
      // Paname√±os nacidos antes de la vigencia: 1AV-xxxx-xxxxx hasta 13AV-xxxx-xxxxx
      const regexAntesVigencia = /^([1-9]|1[0-3])AV-(\d{1,4})-(\d{1,5})$/;
      
      // Poblaci√≥n ind√≠gena: 1PI-xxxx-xxxxx hasta 13PI-xxxx-xxxxx
      const regexIndigena = /^([1-9]|1[0-3])PI-(\d{1,4})-(\d{1,5})$/;

      if (regexRegular.test(cedulaLimpia)) {
        return { valida: true, mensaje: 'C√©dula regular v√°lida', tipo: 'Regular' };
      }
      
      if (regexPE.test(cedulaLimpia)) {
        return { valida: true, mensaje: 'C√©dula de paname√±o nacido en el extranjero v√°lida', tipo: 'PE' };
      }
      
      if (regexExtranjero.test(cedulaLimpia)) {
        return { valida: true, mensaje: 'C√©dula de extranjero v√°lida', tipo: 'Extranjero' };
      }
      
      if (regexNaturalizado.test(cedulaLimpia)) {
        return { valida: true, mensaje: 'C√©dula de naturalizado v√°lida', tipo: 'Naturalizado' };
      }
      
      if (regexAntesVigencia.test(cedulaLimpia)) {
        return { valida: true, mensaje: 'C√©dula de paname√±o nacido antes de la vigencia v√°lida', tipo: 'Antes de vigencia' };
      }
      
      if (regexIndigena.test(cedulaLimpia)) {
        return { valida: true, mensaje: 'C√©dula de poblaci√≥n ind√≠gena v√°lida', tipo: 'Poblaci√≥n ind√≠gena' };
      }

      // Mensajes de error espec√≠ficos
      if (/^\d+-/.test(cedulaLimpia)) {
        const numero = parseInt(cedulaLimpia.split('-')[0]);
        if (numero > 13) {
          return { valida: false, mensaje: 'Las c√©dulas regulares solo pueden empezar del 1 al 13' };
        }
      }
      
      if (/^\d+AV-/.test(cedulaLimpia)) {
        const numero = parseInt(cedulaLimpia.split('AV-')[0]);
        if (numero > 13 || numero < 1) {
          return { valida: false, mensaje: 'Las c√©dulas AV (antes de vigencia) solo pueden empezar del 1AV al 13AV' };
        }
      }
      
      if (/^\d+PI-/.test(cedulaLimpia)) {
        const numero = parseInt(cedulaLimpia.split('PI-')[0]);
        if (numero > 13 || numero < 1) {
          return { valida: false, mensaje: 'Las c√©dulas PI (poblaci√≥n ind√≠gena) solo pueden empezar del 1PI al 13PI' };
        }
      }

      return { 
        valida: false, 
        mensaje: 'Formato no v√°lido. Usa: 1-123-456 (1-13), PE-123-456, E-123-456789, N-123-456, 1AV-123-456 (1-13AV), 1PI-123-456 (1-13PI)' 
      };
    }

    // Funci√≥n para validar contrase√±a
    function validarContrasena(password, confirmPassword = null) {
      const errores = [];
      
      // Validar longitud
      if (password.length < 8) {
        errores.push('Debe tener al menos 8 caracteres');
      }
      if (password.length > 16) {
        errores.push('No puede tener m√°s de 16 caracteres');
      }
      
      // Validar que tenga al menos un n√∫mero
      if (!/\d/.test(password)) {
        errores.push('Debe contener al menos 1 n√∫mero');
      }
      
      // Validar que tenga al menos un s√≠mbolo
      if (!/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) {
        errores.push('Debe contener al menos 1 s√≠mbolo (!@#$%^&*()_+-=[]{}|;:,.<>?)');
      }
      
      // Validar que las contrase√±as coincidan (si se proporciona confirmaci√≥n)
      if (confirmPassword !== null && password !== confirmPassword) {
        errores.push('Las contrase√±as no coinciden');
      }
      
      return {
        valida: errores.length === 0,
        errores: errores,
        mensaje: errores.length === 0 ? 'Contrase√±a v√°lida' : errores.join(', ')
      };
    }

    // Validaci√≥n en tiempo real
    const cedulaInput = document.getElementById('cedula');
    let timeoutValidacion;
    
    // Agregar estilos CSS para feedback visual
    const style = document.createElement('style');
    style.textContent = `
      .input-valid {
        border: 2px solid #388e3c !important;
        background-color: #f1f8e9 !important;
      }
      .input-invalid {
        border: 2px solid #d32f2f !important;
        background-color: #ffebee !important;
      }
      .cedula-feedback {
        font-size: 0.8em;
        margin-top: -8px;
        margin-bottom: 8px;
        padding: 4px 8px;
        border-radius: 4px;
        display: none;
      }
      .feedback-valid {
        color: #2e7d32;
        background-color: #e8f5e8;
        border: 1px solid #4caf50;
      }
      .feedback-invalid {
        color: #d32f2f;
        background-color: #ffebee;
        border: 1px solid #f44336;
      }
    `;
    document.head.appendChild(style);
    
    // Crear div para feedback
    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = 'cedula-feedback';
    feedbackDiv.id = 'cedula-feedback';
    cedulaInput.parentNode.insertBefore(feedbackDiv, cedulaInput.nextSibling);
    
    // Filtro de entrada: solo n√∫meros, guiones y letras permitidas
    cedulaInput.addEventListener('keypress', function(e) {
      const char = e.key.toUpperCase();
      const currentValue = this.value;
      
      // Permitir solo n√∫meros, guiones y letras espec√≠ficas (P, E, A, N, V, I)
      const allowedChars = ['0','1','2','3','4','5','6','7','8','9','-','A','E','I','N','P','V'];
      
      if (!allowedChars.includes(char)) {
        e.preventDefault();
        return false;
      }
      
      // Contar guiones actuales
      const currentDashes = (currentValue.match(/-/g) || []).length;
      
      // Si ya hay 2 guiones, no permitir m√°s
      if (char === '-' && currentDashes >= 2) {
        e.preventDefault();
        return false;
      }
      
      // Permitir todas las letras, la validaci√≥n contextual se har√° despu√©s
      // Esto permite mayor flexibilidad al usuario
    });
    
    // Tambi√©n filtrar en el evento input para pegado de texto
    cedulaInput.addEventListener('input', function() {
      let value = this.value;
      
      // Convertir a may√∫sculas autom√°ticamente
      value = value.toUpperCase();
      
      // Filtrar caracteres no permitidos usando replace con funci√≥n
      value = value.replace(/./g, function(char) {
        const allowedChars = ['0','1','2','3','4','5','6','7','8','9','-','A','E','I','N','P','V'];
        return allowedChars.includes(char) ? char : '';
      });
      
      // Contar guiones y limitar a m√°ximo 2
      const dashCount = (value.match(/-/g) || []).length;
      if (dashCount > 2) {
        let dashesFound = 0;
        value = value.replace(/-/g, function(match) {
          dashesFound++;
          return dashesFound <= 2 ? match : '';
        });
      }
      
      // Actualizar el valor si cambi√≥
      if (this.value !== value) {
        this.value = value;
      }
      
      // Continuar con la validaci√≥n en tiempo real
      clearTimeout(timeoutValidacion);
      
      // Remover clases previas
      this.classList.remove('input-valid', 'input-invalid');
      feedbackDiv.style.display = 'none';
      
      const valor = value.trim();
      
      if (valor.length > 2) {
        timeoutValidacion = setTimeout(() => {
          const resultado = validarCedulaPanama(valor);
          
          if (resultado.valida) {
            cedulaInput.classList.add('input-valid');
            feedbackDiv.className = 'cedula-feedback feedback-valid';
            feedbackDiv.textContent = `‚úì ${resultado.mensaje}`;
            feedbackDiv.style.display = 'block';
          } else {
            cedulaInput.classList.add('input-invalid');
            feedbackDiv.className = 'cedula-feedback feedback-invalid';
            feedbackDiv.textContent = `‚úó ${resultado.mensaje}`;
            feedbackDiv.style.display = 'block';
          }
        }, 500);
      }
    });

    // Evento para el bot√≥n de recuperar contrase√±a
    function mostrarRecuperar() {
    document.getElementById('formLogin').style.display = 'none';
    document.getElementById('formRegister').style.display = 'none';
    document.getElementById('formRecuperar').style.display = 'block';
  }

  // Evento para mostrar el formulario de login
  function mostrarLogin() {
    document.getElementById('formLogin').style.display = 'block';
    document.getElementById('formRegister').style.display = 'none';
    document.getElementById('formRecuperar').style.display = 'none';
  }

  //Funci√≥n para alternar entre los formularios de login y registro
  function toggleForm() {
    const login = document.getElementById("formLogin");
    const register = document.getElementById("formRegister");
    login.style.display = login.style.display === "none" ? "block" : "none";
    register.style.display = register.style.display === "none" ? "block" : "none";
  }
  
  //funci√≥n para manejar el login
  async function handleLogin() {
    const btnLogin = document.getElementById('btnLogin');
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const mensajeDiv = document.getElementById('mensajeLogin');
    mensajeDiv.textContent = ''; // Limpiar mensaje anterior

    // Validaci√≥n de campos
    if (!email || !password) {
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = 'Por favor, completa todos los campos.';
      return;
    }

    // Evitar m√∫ltiples env√≠os
    if (btnLogin.disabled) {
      return;
    }

    // Deshabilitar bot√≥n durante el proceso
    btnLogin.disabled = true;
    const textoOriginal = btnLogin.textContent;
    btnLogin.textContent = 'Ingresando...';

    try {
      const response = await fetch('/scah/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo: email, contrasena: password }),
      });
      
      const data = await response.json();
      
      if (response.ok) {
        mensajeDiv.style.color = '#388e3c';
        mensajeDiv.textContent = 'Login exitoso';
        
        if (data.user && data.user.rol) {
          if (data.user.rol === 'paciente') {
            setTimeout(() => { window.location.replace('../vista_paciente/dashboardPaciente.html'); }, 2000);
          } else if (data.user.rol === 'medico') {
            setTimeout(() => { window.location.replace('../vista_medico/vistaMedico.html'); }, 2000);
          } else if (data.user.rol === 'administrativo') {
            setTimeout(() => { window.location.replace('../vista_administrativo/dashboardAdministrativo.html'); }, 2000);
          }
        } else {
          // Si no hay rol, redirige por defecto
          setTimeout(() => { window.location.replace('home.html'); }, 2000);
        }
      } else {
        // Rehabilitar bot√≥n en caso de error
        btnLogin.disabled = false;
        btnLogin.textContent = textoOriginal;
        mensajeDiv.style.color = '#d32f2f';
        mensajeDiv.textContent = data.message || 'Error al iniciar sesi√≥n';
      }
    } catch (error) {
      // Manejar errores de conexi√≥n
      btnLogin.disabled = false;
      btnLogin.textContent = textoOriginal;
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = 'Error de conexi√≥n. Por favor, intenta de nuevo.';
      console.error('Error en login:', error);
    }
  }

  //Funci√≥n para manejar el registro
  async function handleRegister() {
    const btnRegistrarse = document.getElementById('btnRegistrarse');
    const spinnerRegister = document.getElementById('spinnerRegister');
    const mensajeDiv = document.getElementById('mensajeRegister');
    
    // Evitar m√∫ltiples env√≠os
    if (btnRegistrarse.disabled) {
      return;
    }
    
    // Obt√©n las referencias a los inputs
  const cedulaInput = document.getElementById('cedula');
  const primerNombreInput = document.getElementById('primer_nombre');
  const segundoNombreInput = document.getElementById('segundo_nombre');
  const primerApellidoInput = document.getElementById('primer_apellido');
  const segundoApellidoInput = document.getElementById('segundo_apellido');
  const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
  const telefonoInput = document.getElementById('telefono');
  const correoInput = document.getElementById('emailRegister');
  const direccionInput = document.getElementById('direccion');
  const contrasenaInput = document.getElementById('passwordRegister');
  const confirmarContrasenaInput = document.getElementById('confirmPasswordRegister');

  // Limpiar mensaje anterior
  mensajeDiv.textContent = '';
  mensajeDiv.style.color = '#d32f2f';

  // Obt√©n los valores
  const cedula = cedulaInput.value.toUpperCase(); // Asegurar que est√© en may√∫sculas
  const primer_nombre = primerNombreInput.value;
  const segundo_nombre = segundoNombreInput.value;
  const primer_apellido = primerApellidoInput.value;
  const segundo_apellido = segundoApellidoInput.value;
  const fecha_nacimiento = fechaNacimientoInput.value;
  const telefono = telefonoInput.value;
  const correo = correoInput.value;
  const direccion = direccionInput.value;
  const contrasena = contrasenaInput.value;
  const confirmarContrasena = confirmarContrasenaInput.value;

    // Quitar errores previos
    cedulaInput.classList.remove('input-error');
    primerNombreInput.classList.remove('input-error');
    primerApellidoInput.classList.remove('input-error');
    fechaNacimientoInput.classList.remove('input-error');
    correoInput.classList.remove('input-error');
    contrasenaInput.classList.remove('input-error');
    confirmarContrasenaInput.classList.remove('input-error');
    telefonoInput.classList.remove('input-error');

    // Validaci√≥n b√°sica
    let hasError = false;
    if (!cedula) { cedulaInput.classList.add('input-error'); hasError = true; }
    if (!primer_nombre) { primerNombreInput.classList.add('input-error'); hasError = true; }
    if (!primer_apellido) { primerApellidoInput.classList.add('input-error'); hasError = true; }
    if (!fecha_nacimiento) { fechaNacimientoInput.classList.add('input-error'); hasError = true; }
    if (!correo) { correoInput.classList.add('input-error'); hasError = true; }
    if (!contrasena) { contrasenaInput.classList.add('input-error'); hasError = true; }
    if (!confirmarContrasena) { confirmarContrasenaInput.classList.add('input-error'); hasError = true; }
    if (!telefono) { telefonoInput.classList.add('input-error'); hasError = true; }
    
    // Si hay alg√∫n error, mostrar mensaje y detener el registro
    if (hasError) {
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = 'Por favor, completa todos los campos obligatorios.';
      return;
    }
    
    // Validaci√≥n de c√©dula/pasaporte usando nuestra funci√≥n personalizada
    const resultadoValidacion = validarCedulaPanama(cedula);
    if (!resultadoValidacion.valida) {
      cedulaInput.classList.add('input-error');
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = resultadoValidacion.mensaje;
      return;
    }
    
    // Validaci√≥n de email simple
    if (!/\S+@\S+\.\S+/.test(correo)) {
      correoInput.classList.add('input-error');
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = 'Correo electr√≥nico no v√°lido.';
      return;
    }
    
    // Validaci√≥n de contrase√±a usando nuestra funci√≥n personalizada
    const resultadoContrasena = validarContrasena(contrasena, confirmarContrasena);
    if (!resultadoContrasena.valida) {
      contrasenaInput.classList.add('input-error');
      if (contrasena !== confirmarContrasena) {
        confirmarContrasenaInput.classList.add('input-error');
      }
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = resultadoContrasena.mensaje;
      return;
    }

    // Validaci√≥n de tel√©fono (debe tener formato XXXX-XXXX)
    const telefonoLimpio = telefono.replace(/\D/g, ''); // Remover todo lo que no sea n√∫mero
    if (telefonoLimpio.length < 8) {
      telefonoInput.classList.add('input-error');
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = 'El tel√©fono debe tener al menos 8 d√≠gitos.';
      return;
    }
    
    // Deshabilitar bot√≥n y mostrar spinner
    btnRegistrarse.disabled = true;
    const textoOriginal = btnRegistrarse.textContent;
    btnRegistrarse.textContent = 'Procesando...';
    spinnerRegister.style.display = 'block';
    
    try {
      const response = await fetch('/scah/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          cedula, primer_nombre, segundo_nombre, primer_apellido,
          segundo_apellido, fecha_nacimiento, telefono, correo,
          direccion, contrasena
        }),
      });
      
      const data = await response.json();
      
      // Ocultar spinner
      spinnerRegister.style.display = 'none';
      
      if (response.ok) {
        mensajeDiv.style.color = '#388e3c';
        mensajeDiv.textContent = data.message || 'Se ha enviado un c√≥digo de verificaci√≥n a tu correo';
        
        // Redirigir a la p√°gina de verificaci√≥n con el token seguro
        setTimeout(() => {
          window.location.href = `/scah/vista_general/verificar-registro.html?token=${encodeURIComponent(data.token)}`;
        }, 1500);
      } else {
        // Rehabilitar bot√≥n en caso de error
        btnRegistrarse.disabled = false;
        btnRegistrarse.textContent = textoOriginal;
        mensajeDiv.style.color = '#d32f2f';
        mensajeDiv.textContent = data.message || 'Error en el registro';
      }
    } catch (error) {
      // Manejar errores de conexi√≥n
      spinnerRegister.style.display = 'none';
      btnRegistrarse.disabled = false;
      btnRegistrarse.textContent = textoOriginal;
      mensajeDiv.style.color = '#d32f2f';
      mensajeDiv.textContent = 'Error de conexi√≥n. Por favor, intenta de nuevo.';
      console.error('Error en registro:', error);
    }
  }

  // Funci√≥n para manejar la recuperaci√≥n de contrase√±a
  async function handleRecuperar(e) {
    e.preventDefault();
    const email = document.getElementById('emailRecuperar').value;
    const mensajeDiv = document.getElementById('mensajeRecuperar');
    const spinner = document.getElementById('spinner');
    const btnRecuperar = document.getElementById('btnRecuperar');
    mensajeDiv.textContent = '';
    mensajeDiv.style.color = '#d32f2f';

    if (!email) {
      mensajeDiv.textContent = 'Por favor, ingresa tu correo.';
      return;
    }
    if (!/\S+@\S+\.\S+/.test(email)) {
      mensajeDiv.textContent = 'Correo electr√≥nico no v√°lido.';
      return;
    }

    spinner.style.display = 'block';
    btnRecuperar.disabled = true;
    const originalText = btnRecuperar.textContent;
    btnRecuperar.textContent = 'Enviando...';

    try {
      const response = await fetch('/scah/api/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo: email }),
      });
      const data = await response.json();
      spinner.style.display = 'none'; // Ocultar spinner
      btnRecuperar.disabled = false;
      btnRecuperar.textContent = originalText;

      if (response.ok) {
        mensajeDiv.style.color = '#388e3c';
        mensajeDiv.textContent = 'Si el correo existe, se ha enviado un enlace para restablecer la contrase√±a';
      } else {
        mensajeDiv.textContent = data.message || 'Error al enviar el correo.';
      }
    } catch (error) {
      spinner.style.display = 'none';
      btnRecuperar.disabled = false;
      btnRecuperar.textContent = originalText;
      mensajeDiv.textContent = 'Error de conexi√≥n';
    }
}

    document.getElementById('btnLogin').addEventListener('click', handleLogin);
    document.getElementById('btnRegistrarse').addEventListener('click', handleRegister);
    document.getElementById('btnRecuperar').addEventListener('click', handleRecuperar);
  </script>
</body>
</html>
